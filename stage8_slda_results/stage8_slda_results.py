# -*- coding: utf-8 -*-
"""stage8_slda_results.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Dvh-PEouaGRA9xZlBMafsE-th3nX8hqz
"""

import os
print(os.getcwd())

from google.colab import drive
drive.mount('/mnt/gdrive')

import pandas as pd
import numpy as np
import os


import matplotlib.pyplot as plt

RES_PATH = "/mnt/gdrive/MyDrive/SLDA_checkpoints/slda_results.csv"
OUT_DIR  = "/mnt/gdrive/MyDrive/SLDA_checkpoints"
os.makedirs(OUT_DIR, exist_ok=True)

# Stage-1
stage1_snapshot = {
    "Article 2": {"acc": 0.9128787878787878, "f1_macro": 0.7395423261294556},
    "Article 3": {"acc": 0.8527696793002916, "f1_macro": 0.4841385335735618},
    "Article 7": {"acc": 0.9139941690962099, "f1_macro": 0.7116921972483822},
    "Article 8": {"acc": 0.9547325102880658, "f1_macro": 0.901249643259833},
}

df = pd.read_csv(RES_PATH)

rows = []
all_articles = sorted(set(df["eval_on"].unique()) | set(stage1_snapshot.keys()))
for art in all_articles:
    base_acc = stage1_snapshot.get(art, {}).get("acc", np.nan)
    base_f1  = stage1_snapshot.get(art, {}).get("f1_macro", np.nan)

    sub = df[df["eval_on"] == art]
    if len(sub):
        best = sub.loc[sub["f1_macro"].idxmax()]
        s2_model = best["article_model"]
        s2_acc   = float(best["acc"])
        s2_f1    = float(best["f1_macro"])
        gain     = s2_f1 - base_f1 if not np.isnan(base_f1) else np.nan
    else:
        s2_model = np.nan
        s2_acc   = np.nan
        s2_f1    = np.nan
        gain     = np.nan

    rows.append({
        "Article": art,
        "Stage-1 Acc": base_acc,
        "Stage-1 F1": base_f1,
        "Best Stage-2 Model": s2_model,
        "Stage-2 Acc": s2_acc,
        "Stage-2 F1": s2_f1,
        "F1 Gain": gain,
    })

summary_df = pd.DataFrame(rows)
summary_df = summary_df.sort_values(["F1 Gain", "Stage-2 F1"], ascending=[False, False], na_position="last")
print(summary_df)

# Save
out_path = os.path.join(OUT_DIR, "slda_summary.csv")
summary_df.to_csv(out_path, index=False)
print("Saved:", out_path)

import os
import numpy as np
import matplotlib.pyplot as plt

# data from  logs
articles = ["Article 2", "Article 3", "Article 7", "Article 8"]

# Stage-1 per-article macro-F1
stage1_f1 = [0.7395423261294556, 0.4841385335735618, 0.7116921972483822, 0.901249643259833]

# Stage-2 (best epoch) macro-F1
stage2_f1 = [0.763752, 0.777614, 0.790553, 0.927847]

# Optional: Stage-1 overall macro-F1 on combined validation
S1_OVERALL_MACROF1 = 0.694493

# output path
OUT_DIR = "/content/slda_png"
os.makedirs(OUT_DIR, exist_ok=True)
out_path = os.path.join(OUT_DIR, "slda_f1_grouped_research.png")

# Okabeâ€“Ito palette
COL_STAGE1 = "#0072B2"  # blue
COL_STAGE2 = "#D55E00"  # vermillion
COL_BASE   = "#4D4D4D"  # gray
EDGE       = "#222222"

#  plot
x = np.arange(len(articles))
width = 0.36

plt.figure(figsize=(8.6, 4.6))
b1 = plt.bar(x - width/2, stage1_f1, width, color=COL_STAGE1, edgecolor=EDGE, linewidth=0.6, label="Stage-1")
b2 = plt.bar(x + width/2, stage2_f1, width, color=COL_STAGE2, edgecolor=EDGE, linewidth=0.6, label="Stage-2")

plt.xticks(x, articles, fontsize=11)
plt.ylim(0.4, 1.02)
plt.ylabel("Macro-F1", fontsize=12)
plt.title("Macro-F1 by Article: Stage-1 vs Stage-2 ", fontsize=13)

# subtle grid
ax = plt.gca()
ax.yaxis.grid(True, linestyle=":", linewidth=0.7, alpha=0.6)
ax.set_axisbelow(True)

# annotate values
for r, v in zip(b1, stage1_f1):
    plt.text(r.get_x()+r.get_width()/2, v+0.01, f"{v:.3f}", ha="center", va="bottom", fontsize=9)
for r, v in zip(b2, stage2_f1):
    plt.text(r.get_x()+r.get_width()/2, v+0.01, f"{v:.3f}", ha="center", va="bottom", fontsize=9)

# constant Stage-1 overall baseline (combined)
plt.axhline(S1_OVERALL_MACROF1, color=COL_BASE, linestyle="--", linewidth=1.2,
            label=f"Stage-1 overall = {S1_OVERALL_MACROF1:.6f}")

plt.legend(frameon=False, fontsize=11)
plt.tight_layout()
plt.savefig(out_path, dpi=300, bbox_inches="tight")
plt.show()

print("Saved to:", out_path)

